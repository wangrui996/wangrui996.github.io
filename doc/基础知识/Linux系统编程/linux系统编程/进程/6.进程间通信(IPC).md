

# 进程间通信  IPC

IPC InterProcess Communication  进程间通信   

**原理**： 两个独立的进程各自拥有4G虚拟内存空间，其中3-4G位内核空间，操心系统只有一个，因此父子进程拥有相同的内核空间  

因此，**进程间通信实现的本质，是利用内核空间中的一块缓冲区buf，默认大小4096**  

## 进程间通信的方式  

* 管道：简单  (只能应用在有血缘关系的进程间，如父子进程 兄弟进程间)  完全独立的两个进程无法用管道通信
* 信号：开销最小   携带的数据量比较单一，但是开销小  
* 贡献内存映射区(mmap映射区)    非血缘关系进程间
* 本地套接字(最稳定)  实现复杂 网络中socket套接字   


## 管道  


### 管道的特质  

linux下7中常见的文件类型  普通文件、目录、软连接(这三种是真正占用磁盘空间的)、字符设备文件、块设备文件、管道文件、套接字(伪文件，不是真正的文件，不占用磁盘空间，只占用内存）  

![image](https://user-images.githubusercontent.com/58176267/162149664-3e3fbffe-e374-4496-bc92-4d1b3c362ac8.png)



* 特质  
    * 伪文件
    * 由两个文件描述符引用，一个表示读端，一个表示写端
    * 规定数据从管道的写端流入管道，从读端流出  

* **：内核借助环形队列机制，使用内核缓冲区实现**  

* **局限性**  
    * 数据不能自己写自己读 因为不是一个真正的文件，管道必须要有两端，一个读端一个写端
    * 管道中数据不能反复读取，读走后管道中就不存在这个数据
    * 半双工通信
    * 只能在有公共祖先的进程间通信，即有血缘关系


### 管道基本用法  

**函数原型**

```c
int pipe(int pipefd[2]);
```

**调用该函数会创建并打开一个管道，读端和写端都打开**

**参数**  
* pipefd ： 整型描述符数组
* pipefd[0]  读端  
* pipefd[1]  写端  

**返回值**  

* 成功：0
* 失败  -1  设置errno  


#### demo

父子进程共享文件描述符

* 父进程中 int fd[2]  则父进程有fd[0]和fd[1]，也就是有管道的读端和写端  
* 子进程创建后，也有fd[0]和fd[1]  

![image](https://user-images.githubusercontent.com/58176267/162156712-ef97fa22-f0e6-48c2-b1eb-78bbd676ea44.png)


* 管道的内部数据要求单向流动，假设父进程写，子进程读   则父进程应该关闭读端，子进程应该关闭写端  


```c
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void sys_err(const char* str ) 
{
	perror(str);
	exit(1);
}


int main(int argc, char** argv)
{
	int ret;
	int fd[2];
	pid_t pid;
	
	char *str = "hello pipe\n";
	char buf[1024];  
	
	// 创建并打开管道
	ret = pipe(fd);
	
	if(ret == -1) {
		sys_err("pipe error");
	}
	
	pid = fork();

	if(pid > 0) {
		close(fd[0]); //父进程关闭读端
		write(fd[1], str, strlen(str)); //写入管道数据
		close(fd[1]); //父进程关闭写端
	} else if(pid == 0) {
		close(fd[1]); //子进程关闭写端
		ret = read(fd[0], buf, sizeof(buf)); //read函数返回读到的字节数  
		write(STDOUT_FILENO, buf, ret);
		close(fd[0]);
		
	}
	
	return 0;

}
```

![image](https://user-images.githubusercontent.com/58176267/162159235-a76fb260-5aee-4b75-b132-ea7bee3837c4.png)

















