# 4.从生磁盘到文件  


## 操作系统对磁盘使用的第三层抽象  

* **明确这次抽象的目的：希望从文件 得到 盘块号**  
    * 用户眼中的文件是字符序列，字符流 因此，任务是 如何根据字符流计算出它属于哪一个盘块  
* **核心： 建立字符流到盘块集合的映射关系**  

![image](https://user-images.githubusercontent.com/58176267/171355623-26756ddc-df0a-4642-b4be-96d09cc2e71e.png)

## 连续结构实现文件(映射关系)

* 这种映射结构，可以用多种方案实现，如连续结构实现  一旦确定后，就能根据一个数字范围唯一确定一个盘块  
    * 比如下图中，假设0-99字节放在6号盘块，100-199放在7号盘块 200-212属于200-299之间，所以在8号盘块  
    * 一旦给出如200-212这种值，就能根据一个盘块存放多少数据，计算出属于哪个盘块，对于linux0.11来说，一个盘块是2个扇区，1K字节
* 对于连续结构来说，对于映射表，需要存放：
    * 用户输入的200，要根据200/100(2) + 6(初始盘块)得到8  这里的100是已知的，对于test.c，表中需要存放数字6，即第一个块的块号，**存放在这个表对应的一个数据结构 FCB**   
* 对于一个文件，有了这个FCB数据结构，这张表，对于用户输入的任意一个数字，即要处理的第几个字符，通过简单的公式就可以计算出这个字符所在盘块，公式中需要的值如一个盘块的字节数是初始化好的，起始块是查表得到的。

![image](https://user-images.githubusercontent.com/58176267/171359111-a1b13c72-620e-42c7-8f5c-22dd036fa987.png)

* **连续结构实现文件缺点**  
    * 比如从盘块6起始的文件test.c，一直增加，当增加到13以后，再增加就会占用另一个文件了，此时需要将即将被覆盖的文件整体向后移动，一是后面不一定有足够空间，二是移动太耗时；  
    * **该方式不适合于动态增长，直接读写会比较合适(类似数组， 连续结构随机存取查找)**  

## 链式结构实现文件(映射关系)  

* 动态变化比较快，存取慢  

![image](https://user-images.githubusercontent.com/58176267/171361853-5554b039-885f-4ed8-8c7d-ff26757e52ba.png)


## 索引结构实现文件 (index)   

* 文件的Inode中，I就是这里的Index, node就是链式结构中每个节点，就可以叫做一个node  
* **索引结构**  
    * 每个文件的FCB中记录一个索引块盘号 如text.c的FCB表，索引块是19  (**这里的结构体FCB就是文件的Inode？**) 在用open打开文件时，要读入它的盘块号，读出索引块  
    * 这个盘块19记录了test文件的所有盘块，按顺序去找，因为一直每个盘块大小，所以200，就可以知道在第三个盘块，即盘块号为1   
* 扩展：只需要再找一个空间块，不需要连续，如将盘块25填到10后面的-1位置(原来-1表示结束)  
* 读写：读写起来比链式结构快，因为Inode中提供的索引块19中，不像链式结构，存放的是存放文件数据的下一盘块号，而是这个文件所有的，连续的盘块号  

![image](https://user-images.githubusercontent.com/58176267/171364141-7f6b35db-93a1-4c79-aafa-8b7efe694c06.png)  


## 实际系统是多级索引  

* 多级索引后，小文件可以直接Inode中存放的就是索引块  
* 中等大小的，可以一级间接索引，文件的Inode中存放的盘块号中，存放的不再是该文件的数据，而是其他索引块，每一个索引块又对应一个数据块  
* ....  

![image](https://user-images.githubusercontent.com/58176267/171365123-918e8c00-b578-4aad-a4bb-8069bcbde42b.png)  


## 习题  

* 因为单词数量比较固定，一个不需要动态增长，只需要快速查询的文件，用顺序结构最好

![image](https://user-images.githubusercontent.com/58176267/171365456-3bb654a8-0754-41a2-b9e0-5ed3505999b2.png)  




