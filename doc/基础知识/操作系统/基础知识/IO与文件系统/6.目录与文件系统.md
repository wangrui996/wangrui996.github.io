# 6.目录与文件系统  


* 文件系统  抽象整个磁盘————操作系统使用磁盘的第四层抽象  

* 文件系统：将磁盘抽象成目录树的结构   
    * 这里的任务不再是 一个文件怎么映射成一个盘块号 而是一堆文件怎样映射成整个磁盘  
    * 即多个文件怎样处理  
  
![image](https://user-images.githubusercontent.com/58176267/176115175-e1fbc202-4144-473c-b195-2eeb5bccee52.png)


* 最开始操作系统文件就放在一层(一个大集合)  
    * 查找复杂
* 按目录划分，不同用户的文件还是组织成上面集合的形式,每个用户的文件查找还是比较复杂  

![image](https://user-images.githubusercontent.com/58176267/176116169-9fcf20d6-31b1-4ce0-826d-b32f6c304ae5.png)

* 引入目录树  
    * 分治的思想
    * 对划分的集合再进行划分
    * **产生目录概念 由目录形成目录树的结构**

![image](https://user-images.githubusercontent.com/58176267/176116667-ef6e036a-cf0a-442d-ae57-0393ab8dca01.png)


## 实现目录  

* 有了目录，就可以形成目录树的结构，就是一堆文件的组织形式就有了  

* 目录怎么用：对用户而言, 通过一个路径名   "/my/data"  定位文件 a
    * 更准确的来说,是找到文件a的FCB(inode)
    * 得到inode,知道读写位置,就能定位到盘块号 
    * 拿到盘块号，放到电梯队列中 后面在磁盘中断时就可以算出C H S  就可以把这个信息给控制器
    * 控制器拿到CHS，就可以驱动马达读写盘块  
* 任何一个文件，就是目录树中的一个位置,形成一个路径名

![image](https://user-images.githubusercontent.com/58176267/176118297-00664ca2-a39d-405d-918f-69d7e7f42619.png)

* **那么问题关键就是：磁盘块上应该存放什么信息来实现目录？**

## 树状目录的完整实现  

* 根据my 需要能够找到它下面的三个文件 data目录文件、cont文件和mail文件, 什么东西才能让操作系统找到这三个文件？ 也就是要有这三个文件的FCB(inode)  

* 方案1：直接存放文件的FCB
    * 问题是不够高效  因为在某个目录下找到某个文件“mail”, 需要匹配这个字符串, 根据字符串找到其对应的FCB 如果采用方案1，目录my(也是个文件)对应的盘块中应该存放文件名+文件的FCB这样一种对应结构
    * 在解析my目录时，因为不知道需要的某个文件在哪里,需要从盘块中把所有序对读到内存中,然后挨个匹配(如某一个序对的字符串是想要的"mail"，就拿到了他对应的FCB)  
    * 整个过程是非常慢的，只访问一个文件，需要把该目录下所有目录的信息都读进来，挨个匹配  磁盘的读写非常慢因此该方式并不高效  
    
* **既然对于一个目录，它的盘块中不希望存放每个文件的FCB，因为FCB太大了，但是需要和名字匹配，还是需要存放文件名字符串如"data"**
* **那就存放文件名+一个编号  根据这个号能找到该文件在磁盘中对应的盘块号  (类似与指向该文件FCB的指针但指针的概念是内存中的)**  

### 完整实现  

* 目录项 ： 文件名 + 对应的FCB的 “地址”  
    * 一个目录项中存放的是一个字符串 + 一个编号  

* 磁盘中有FCB数组,例如对应根目录"/"，有一个对应的FCB数组存放了根目录下所有文件的FCB, 根目录这个文件的盘块中存放的一个个的目录项  

* 解析一个目录时，读出该目录下所有目录项  匹配字符串后得到想要的文件的FCB编号，到对应的FCB数组中可以直接拿到对应文件的FCB  
    * 拿到了某个文件对应的FCB后,有能拿到这个文件在磁盘中的数据块  数据块中又存放了一个个目录项   

![image](https://user-images.githubusercontent.com/58176267/176123942-3d43bf28-08e3-4968-949c-f259321af2cd.png)

    
* 对于根目录，因为没法事先知道它的FCB的编号，可以固定在位置0  不管将磁盘放在那台机器只要读磁盘就能拿到这个  
* 盘块位图：记录哪些盘块是空闲的 将来使用盘块时如新建一个文件，才能获取空闲盘块  
* inode节点位图：某个文件存在对应的位就是1,文件删除对应的位就是0  
* 超级块 获取inode节点位图长度和盘块位图长度  这样就能知道根目录所在盘块  
    * 一个磁盘想要使用需要先mount到系统中,mount就是要都这个超级块    
* 引导块  

![image](https://user-images.githubusercontent.com/58176267/176137117-062d2ab9-b782-47ab-a961-46877ea63770.png)

    
## 完整的磁盘使用  

![image](https://user-images.githubusercontent.com/58176267/176137837-be542953-f587-4a32-aa52-e89f282db174.png)






