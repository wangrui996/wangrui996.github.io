# 操作系统基础知识  

**操作系统**：计算机硬件和应用之间的一层软件  

**管理**：CPU管理 内存管理  终端管理  磁盘管理  文件管理  网络  ...   


## 汇编基础  


<p  id="操作系统的启动"></p>

## 操作系统的启动  

* 1.上电后先执行内存中固化的汇编程序段，执行的是内存中BIOS映射区代码，主要进行主板、显示器、键盘等检查，并将磁盘0磁道0扇区（512个字节的引导扇区）读入内存的某个地址处  
* 2.磁盘的引导扇区（boot扇区）是启动设备的第一个扇区，也可以认为是操作系统的第一部分（boot扇区）
    * 引导扇区代码：bootsect.s  
        2.1 将bootsect.s代码段向后移动，腾出钱买呢的一段空间（后面可以发现放的是system的代码，最后汇编会有个读磁盘的中断，会将磁盘的第2个扇区开始读，读4个扇区，这部分是setup的四个扇区，读到内存中bootsect后面的位置
        2.2 其中一个功能是将某字符串输出到显示器光标位置  
        2.3 读入system模块  
        2.4 bootsect结束后，需要执行setup，用jmpi命令，修改CS IP位置  
* 3.setup模块
    3.1 读入物理内存大小(要管理内存必须的操作，比如分页？)
    3.2 将system模块移到0地址
    **3.3 进入保护模式：也就是将原来的实模式寻址方式修改为32寻址，具体操作是通过修改cr0寄存器最低位为1，即进入保护模式（就会走另外一条解释执行指令的电路）*  
    **保护模式下的地址翻译和中断处理：gdt（硬件实现了，软件也可以做但硬件实现后速度会快） 此时CS不再是地址，而是选择子，即查表的索引，从表中查到真正的基地址后+ip偏移产生最后的地址  这套方案实现的基础就是要有一个表，gdt表（t table）——所以setup还要做的一件事是产生这个表，设置保护模式下的中断和寻址**   
    保护模式下：寻址的CS是需要从表中查到地址，中断的汇编代码int n也是去表中查，找到的是中断函数的入口地址  
    3.4 jmpi 0, 8 根据保护模式下的寻址方式，跳到内存0地址处执行 system代码  

* 4.system模块  

system模块也有很多模块，我们需要先执行特定的模块，如一开始应该执行head.s，编写的system代码是由很多文件编译成的，怎么保证最后生成的代码head.s会先执行？**需要Makefile文件控制**  

4.1 head.s 一段在保护模式下运行的代码（都是32位汇编代码）  
功能： 
   * 重新建立GDT表（刚才只是为了跳转到system代码临时创建的）
   * 使用A20地址线（使用4g内存）
   * 设置页表  
   * 通过汇编调用了C函数，进入main函数，如果main函数返回了，head.s会执行L6,陷入死循环死机，正常情况下不会执行，就是说main函数最后不会退出  

4.2 main 函数  
初始化内存、初始化硬盘、外设等  
以初始化内存为例
```c
//源码在linux/mm/memory.c中
void mem_init(long start_mem, long end_mem)
{
   int i;
   for(i = 0; i < PAGING_PAGES; i++)
      mem_map[i] = USED; //初始化mem_map表格，实际上是个数组，值为0表示这段内存没有被使用，下面就写了个循环全部置为0；
   i = MAP_NR(start_mem);
   end_mem -= start_mem;
   end_mem >>= 12; //右移12位，相当于除以2^12(4K)
   //相当于每减去4k作为一片，置为0
   while(end_mem -- > 0)
      mem_map[i++] = 0; 
}
```  
**main函数的内存初始化函数，实际上就是形成一个表格（本质是数组），用这个表格表示内存中哪些地方是使用的，哪些地方没被使用， 初始化的时候不是整个内存都被置0，而是有一部分已经被使用，即操作系统使用了一部分，就是上面传递进来的参数，其中long end_mem是内存大小，这个参数在前面setup.s读入如90002，知道到底多少有多少内存**  






**注意：**  
一开始的寻址方式（实模式）CS:IP(CS左移4位+IP)  
保护模式下寻址方式：32位寻址  

setup最后就需要把寻址方式转换，因为实模式下的方式，CS和IP是16位地址，CS左移4位也才32位地址，支持的内存寻址范围是很小的，而我们的内存通常4G，完全不够
